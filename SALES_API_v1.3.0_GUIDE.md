# Sales & Customer Management API - ุฅุตุฏุงุฑ v1.3.0

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุถุงูุฉ ูุงุฌูุงุช ุจุฑูุฌุฉ ุชุทุจููุงุช ูุงููุฉ ูุฅุฏุงุฑุฉ ุทูุจุงุช ุงูุจูุน ูุงูุนููุงุก ูุนุฑูุถ ุงูุฃุณุนุงุฑ ูู ุงูุฅุตุฏุงุฑ v1.3.0.

---

## ๐ ูุงุฌูุงุช ุทูุจุงุช ุงูุจูุน (Sales Orders API)

### 1. ุฅูุดุงุก ุทูุจ ุจูุน ุฌุฏูุฏ
**POST** `/sales/orders`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: Admin ุฃู Cashier

**Body:**
```json
{
  "customer_id": 1,
  "items": [
    {
      "product_id": 5,
      "variant_id": null,
      "quantity": 10,
      "unit_price": 150.00,
      "discount": 10.0
    },
    {
      "product_id": 7,
      "variant_id": 3,
      "quantity": 5,
      "unit_price": 250.00,
      "discount": 0
    }
  ],
  "notes": "ุทูุจ ูู ุงูุนููู VIP",
  "payment_method": "ููุฏู"
}
```

**Response:**
```json
{
  "id": 21
}
```

**ููุงุญุธุงุช:**
- ูุชู ุชูููุฏ ุฑูู ูุงุชูุฑุฉ ุชููุงุฆูุงู ุจุงูุตูุบุฉ `ORD-{timestamp}`
- `variant_id` ุงุฎุชูุงุฑู (ููุณุชุฎุฏู ูู batch_id ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)
- `discount` ูุณุจุฉ ูุฆููุฉ (0-100)
- ุงููุจูุบ ุงูุฅุฌูุงูู ููุญุณุจ ุชููุงุฆูุงู: `quantity * unit_price * (1 - discount/100)`

---

### 2. ุนุฑุถ ูุงุฆูุฉ ุทูุจุงุช ุงูุจูุน
**GET** `/sales/orders?page=1&page_size=50`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู

**Response:**
```json
{
  "items": [
    {
      "id": 21,
      "invoice_number": "ORD-1763548442",
      "customer_id": 11,
      "customer_name": "ุดุฑูุฉ ุงูููุฑ ููุชุฌุงุฑุฉ",
      "total_amount": 1050.00,
      "final_amount": 1050.00,
      "payment_method": "ููุฏู",
      "sale_date": "2025-11-19",
      "created_at": "2025-11-19 11:34:02"
    },
    ...
  ],
  "total": 21,
  "page": 1,
  "page_size": 50,
  "has_next": false
}
```

---

### 3. ุนุฑุถ ุชูุงุตูู ุทูุจ ุจูุน
**GET** `/sales/orders/{order_id}`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู

**Response:**
```json
{
  "id": 21,
  "invoice_number": "ORD-1763548442",
  "customer_id": 11,
  "customer_name": "ุดุฑูุฉ ุงูููุฑ ููุชุฌุงุฑุฉ",
  "total_amount": 1050.00,
  "final_amount": 1050.00,
  "payment_method": "ููุฏู",
  "notes": "ุทูุจ ุงุฎุชุจุงุฑ ูู API",
  "sale_date": "2025-11-19",
  "created_at": "2025-11-19 11:34:02",
  "items": [
    {
      "id": 35,
      "product_id": 1,
      "product_name": "ููุชุฌ ุฑูู 1",
      "batch_id": 1,
      "quantity": 5,
      "unit_price": 100.00,
      "total_price": 450.00
    },
    {
      "id": 36,
      "product_id": 2,
      "product_name": "ููุชุฌ ุฑูู 2",
      "batch_id": 1,
      "quantity": 3,
      "unit_price": 200.00,
      "total_price": 600.00
    }
  ]
}
```

---

## ๐ฅ ูุงุฌูุงุช ุฅุฏุงุฑุฉ ุงูุนููุงุก (Customers API)

### 1. ุฅูุดุงุก ุนููู ุฌุฏูุฏ
**POST** `/customers`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: Admin ููุท

**Body:**
```json
{
  "name": "ุดุฑูุฉ ุงูููุฑ ููุชุฌุงุฑุฉ",
  "phone": "0501234567",
  "email": "alnour@example.com",
  "address": "ุงูุฌุฒุงุฆุฑ ุงูุนุงุตูุฉ - ุญู ุงูุณูุงู",
  "credit_limit": 50000.00,
  "is_active": true
}
```

**Response:**
```json
{
  "id": 11
}
```

---

### 2. ุนุฑุถ ุชูุงุตูู ุนููู
**GET** `/customers/{customer_id}`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู

**Response:**
```json
{
  "id": 11,
  "name": "ุดุฑูุฉ ุงูููุฑ ููุชุฌุงุฑุฉ",
  "phone": "0501234567",
  "email": "alnour@example.com",
  "address": "ุงูุฌุฒุงุฆุฑ ุงูุนุงุตูุฉ - ุญู ุงูุณูุงู",
  "credit_limit": 50000.00,
  "current_balance": 0.00,
  "is_active": 1
}
```

---

### 3. ุนุฑุถ ูุงุฆูุฉ ุงูุนููุงุก
**GET** `/customers?page=1&page_size=50`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู

**Response:**
```json
{
  "items": [
    {
      "id": 11,
      "name": "ุดุฑูุฉ ุงูููุฑ ููุชุฌุงุฑุฉ",
      "phone": "0501234567",
      "email": "alnour@example.com",
      "current_balance": 0.00,
      "created_at": "2025-11-19 11:34:00"
    },
    ...
  ],
  "total": 11,
  "page": 1,
  "page_size": 50,
  "has_next": false
}
```

---

## ๐ฐ ูุงุฌูุงุช ุนุฑูุถ ุงูุฃุณุนุงุฑ (Quotes API)

### 1. ุฅูุดุงุก ุนุฑุถ ุณุนุฑ
**POST** `/sales/quotes`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: Admin ุฃู Cashier

**Body:**
```json
{
  "customer_id": 1,
  "items": [
    {
      "product_id": 1,
      "variant_id": null,
      "quantity": 10,
      "unit_price": 95.00,
      "discount": 5.0
    }
  ],
  "valid_until": "2025-11-26",
  "notes": "ุนุฑุถ ุณุนุฑ ุฎุงุต ููุฏุฉ ุฃุณุจูุน"
}
```

**Response (ุฅุฐุง ูุงู ุฌุฏูู quotes ููุฌูุฏ):**
```json
{
  "id": 5,
  "quote_number": "QT-1763548500"
}
```

**Response (ุฅุฐุง ูุงู ุฌุฏูู quotes ุบูุฑ ููุฌูุฏ):**
```json
{
  "detail": "Quotes feature requires quotes table: NOT NULL constraint failed: quotes.quote_date"
}
```
**Status Code**: 501 (Not Implemented)

---

### 2. ุนุฑุถ ูุงุฆูุฉ ุนุฑูุถ ุงูุฃุณุนุงุฑ
**GET** `/sales/quotes?page=1&page_size=50`

**ุงูุตูุงุญูุงุช ุงููุทููุจุฉ**: ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู

**Response:**
```json
{
  "items": [],
  "total": 0,
  "page": 1,
  "page_size": 50,
  "has_next": false
}
```

---

## ๐ ุงููุตุงุฏูุฉ (Authentication)

ุฌููุน ููุงุท ุงูููุงูุฉ ุชุชุทูุจ JWT token ูู header:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### ุงูุญุตูู ุนูู Token
**POST** `/auth/login`

**Body:**
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in_hours": 24
}
```

---

## ๐ ุฃูุซูุฉ ุงุณุชุฎุฏุงู ูุงููุฉ

### ุณููุงุฑูู 1: ุฅูุดุงุก ุนููู ุฌุฏูุฏ ูุฅูุดุงุก ุทูุจ ุจูุน ูู

```python
import requests

BASE_URL = "http://localhost:8000"

# 1. ุชุณุฌูู ุงูุฏุฎูู
login_res = requests.post(f"{BASE_URL}/auth/login", json={
    "username": "admin",
    "password": "admin123"
})
token = login_res.json()["access_token"]
headers = {"Authorization": f"Bearer {token}"}

# 2. ุฅูุดุงุก ุนููู ุฌุฏูุฏ
customer_res = requests.post(f"{BASE_URL}/customers", json={
    "name": "ูุคุณุณุฉ ุงูุฃูู ุงูุชุฌุงุฑูุฉ",
    "phone": "0559876543",
    "email": "alamal@example.com",
    "address": "ุฌุฏุฉ - ุญู ุงูุณูุงูุฉ",
    "credit_limit": 100000.00,
    "is_active": True
}, headers=headers)
customer_id = customer_res.json()["id"]
print(f"โ ุชู ุฅูุดุงุก ุงูุนููู ุจุฑูู: {customer_id}")

# 3. ุฅูุดุงุก ุทูุจ ุจูุน ููุนููู
order_res = requests.post(f"{BASE_URL}/sales/orders", json={
    "customer_id": customer_id,
    "items": [
        {
            "product_id": 1,
            "variant_id": None,
            "quantity": 20,
            "unit_price": 150.00,
            "discount": 15.0
        }
    ],
    "notes": "ุทูุจ ุงูุชุชุงุญ ุงููุฑุน ุงูุฌุฏูุฏ",
    "payment_method": "ุขุฌู 30 ููู"
}, headers=headers)
order_id = order_res.json()["id"]
print(f"โ ุชู ุฅูุดุงุก ุทูุจ ุงูุจูุน ุจุฑูู: {order_id}")

# 4. ุนุฑุถ ุชูุงุตูู ุงูุทูุจ
order_detail = requests.get(f"{BASE_URL}/sales/orders/{order_id}", headers=headers).json()
print(f"\n๐ ุชูุงุตูู ุงูุทูุจ:")
print(f"   ุฑูู ุงููุงุชูุฑุฉ: {order_detail['invoice_number']}")
print(f"   ุงููุจูุบ ุงูุฅุฌูุงูู: {order_detail['total_amount']} ุฏุฌ")
print(f"   ุทุฑููุฉ ุงูุฏูุน: {order_detail['payment_method']}")
```

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช

ุชู ุฅูุดุงุก ููู ุงุฎุชุจุงุฑุงุช ุดุงูู ูู `test_sales_api.py` ูุบุทู:

- โ ุชุณุฌูู ุงูุฏุฎูู ูุงููุตุงุฏูุฉ
- โ ุฅูุดุงุก ูุนุฑุถ ูุณุฑุฏ ุงูุนููุงุก
- โ ุฅูุดุงุก ูุนุฑุถ ูุณุฑุฏ ุทูุจุงุช ุงูุจูุน
- โ ุฅูุดุงุก ูุณุฑุฏ ุนุฑูุถ ุงูุฃุณุนุงุฑ

**ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช:**
```bash
python test_sales_api.py
```

**ูุชูุฌุฉ ุงูุงุฎุชุจุงุฑุงุช:**
```
============================================================
๐ ุจุฏุก ุงุฎุชุจุงุฑุงุช Sales, Customer, Quotes API
============================================================
โ ุชุณุฌูู ุงูุฏุฎูู: Token = eyJhbGciOiJIUzI1NiIs...

--- ุงุฎุชุจุงุฑุงุช ุงูุนููุงุก ---
โ ุชู ุฅูุดุงุก ุงูุนููู ุจุฑูู: 11
โ ุงุณู ุงูุนููู: ุดุฑูุฉ ุงูููุฑ ููุชุฌุงุฑุฉ
โ ุนุฏุฏ ุงูุนููุงุก: 11

--- ุงุฎุชุจุงุฑุงุช ุทูุจุงุช ุงูุจูุน ---
โ ุชู ุฅูุดุงุก ุงูุทูุจ ุจุฑูู: 21
โ ุฑูู ุงููุงุชูุฑุฉ: ORD-1763548442
   ุงููุจูุบ ุงูุฅุฌูุงูู: 1050
โ ุนุฏุฏ ุงูุทูุจุงุช: 21

--- ุงุฎุชุจุงุฑุงุช ุนุฑูุถ ุงูุฃุณุนุงุฑ ---
โ๏ธ  ุฌุฏูู quotes ุบูุฑ ููุฌูุฏ (ูุชููุน ูู ูุฐู ุงููุณุฎุฉ)
โ ุนุฏุฏ ุนุฑูุถ ุงูุฃุณุนุงุฑ: 0

============================================================
โ ุงูุชูุช ุงูุงุฎุชุจุงุฑุงุช ุจูุฌุงุญ
============================================================
```

---

## ๐ ููุงุญุธุงุช ุชูููุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฌุฏูู `sales`: ูุญูุธ ูุนูููุงุช ุฑุฃุณ ุงูุทูุจ
- ุฌุฏูู `sale_items`: ูุญูุธ ุจููุฏ ุงูุทูุจ (line items)
- ุฌุฏูู `customers`: ูุนูููุงุช ุงูุนููุงุก
- ุฌุฏูู `quotes`: ุนุฑูุถ ุงูุฃุณุนุงุฑ (ูุญุชุงุฌ migration ูุฅุถุงูุฉ ุนููุฏ `quote_date`)

### ูุนุงููุฑ ุงูุจูุงูุงุช
- `batch_id` ูู `sale_items` NOT NULL - ููุณุชุฎุฏู ูู variant_id ุฃู ูููุฉ ุงูุชุฑุงุถูุฉ 1
- `cost_price` ู `profit` ูุชู ุชุนููููุง ุฅูู 0 ุญุงููุงู (ูููู ุชุญุณูููุง ูุงุญูุงู)
- ุฃุฑูุงู ุงูููุงุชูุฑ ุชููููุฏ ุจุงูุตูุบุฉ `ORD-{timestamp}` ุฃู `QT-{timestamp}`

### ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ
- [ ] ุฅุถุงูุฉ endpoint ูุชุฃููุฏ ุทูุจ ุงูุจูุน (confirm order)
- [ ] ุฅุถุงูุฉ endpoint ูุฅูุบุงุก ุทูุจ ุงูุจูุน (cancel order)
- [ ] ุฅุถุงูุฉ endpoint ูุชุญููู ุนุฑุถ ุณุนุฑ ุฅูู ุทูุจ ุจูุน
- [ ] ุฅุถุงูุฉ ุญุณุงุจ ุชููุงุฆู ูู cost_price ู profit ูู ุฌุฏูู ุงููุฎุฒูู
- [ ] ุฅุถุงูุฉ ุฏุนู ุงูุฎุตููุงุช ุนูู ูุณุชูู ุงูุทูุจ (ุจุฌุงูุจ ุฎุตููุงุช ุงูุจููุฏ)
- [ ] ุฅุถุงูุฉ migration ูุฌุฏูู quotes ูุฅุตูุงุญ ุนููุฏ quote_date

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุงูุฅุตุฏุงุฑ v1.3.0 ูุถูู **7 ููุงุท ููุงูุฉ ุฌุฏูุฏุฉ** ูุฅุฏุงุฑุฉ:
- ุทูุจุงุช ุงูุจูุน (ุฅูุดุงุกุ ุนุฑุถุ ุณุฑุฏ)
- ุงูุนููุงุก (ุฅูุดุงุกุ ุนุฑุถุ ุณุฑุฏ)
- ุนุฑูุถ ุงูุฃุณุนุงุฑ (ุฅูุดุงุกุ ุณุฑุฏ)

ุฌููุน ุงูููุงุท ูุญููุฉ ุจู JWT authentication ููุฏุนููุฉ ุจู RBAC (Admin/Cashier roles).

**ูุนุฏู ูุฌุงุญ ุงูุงุฎุชุจุงุฑุงุช**: 100% โ
